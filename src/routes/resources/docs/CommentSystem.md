# Comment System

## Overview

The comment system allows users to leave comments on blog posts and reply to existing comments. It includes features like nested replies, comment editing, and deletion.

## Components

### CommentSection.svelte

Main component that handles the display and management of comments for a post.

**Key Features:**

- Loads comments with pagination
- Handles comment creation, editing, and deletion
- Manages reply expansion/collapse
- Shows loading states
- Toggle comments visibility with hide/show button

**New Feature: Hide/Show Comments**

Users can now toggle the visibility of the comments section using the "Hide" button in the comment section header. When hidden, only the comment count is visible along with a "Show" button to restore the comments.

**Implementation Details:**

- Added `commentsVisible` state variable to control visibility
- Added `toggleCommentsVisibility()` function to switch between states
- Added Eye/EyeOff icons from Lucide Svelte for visual indication
- Wrapped the comment content in a conditional block based on `commentsVisible`

### CommentForm.svelte

Form component for creating new comments and replies.

### CommentItem.svelte

Individual comment display component with edit/delete functionality.

**Recent Fix:**

- Fixed infinite loading issue by adding proper state management with `hasLoaded` flag
- Prevents multiple API calls on component re-renders
- Added proper guards in `loadComments()` function

### CommentForm.svelte

Form component for creating new comments and replies.

### CommentItem.svelte

Individual comment display component with edit/delete functionality.

## Database Schema

The comment system uses the `post_comments` table with the following structure:

```sql
CREATE TABLE post_comments (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    post_id BIGINT NOT NULL REFERENCES posts(id),
    user_id UUID NOT NULL REFERENCES users(id),
    parent_id BIGINT REFERENCES post_comments(id),
    content TEXT NOT NULL,
    is_deleted BOOLEAN DEFAULT FALSE
);
```

## API Functions

### getComments(supabase, postId, page, limit)

Fetches comments for a specific post with pagination.

### getCommentReplies(supabase, commentId)

Fetches replies for a specific comment.

### createComment(supabase, postId, userId, commentData)

Creates a new comment or reply.

### updateComment(supabase, commentId, content, userId)

Updates an existing comment. Requires user authorization - only the comment owner can update their comment.

### deleteComment(supabase, commentId, userId)

Soft deletes a comment by setting `is_deleted` to true. Requires user authorization - only the comment owner can delete their comment.

## Bug Fixes

### Infinite Loading Issue (Fixed)

**Problem:** Comments were being fetched infinitely, causing the loading spinner to never disappear.

**Root Cause:** The `$effect(() => { loadComments(); })` was running on every component re-render without proper dependencies.

**Solution:**

1. Added `hasLoaded` state flag to prevent multiple loads
2. Added proper guards in `loadComments()` function
3. Improved effect dependency management

```svelte
// Before (problematic)
$effect(() => {
    loadComments();
});

// After (fixed)
let hasLoaded = $state(false);

$effect(() => {
    if (postId && !hasLoaded) {
        hasLoaded = true;
        loadComments();
    }
});
```

### Reply Caching Optimization (Implemented)

**Problem:** Replies were being re-fetched from the server every time a user expanded and collapsed comment threads, causing unnecessary API calls and slower UI experience.

**Solution:**

1. Implemented a reply caching mechanism using a Map to store fetched replies
2. Replies are now cached when first loaded and reused on subsequent expansions
3. Cache is properly updated when new replies are added, edited, or deleted

```typescript
// Added reply cache
let repliesCache = $state(new Map<number, PostComment[]>());

// Modified toggleReplies to use cache
async function toggleReplies(commentId: number) {
	if (expandedComments.has(commentId)) {
		// Just collapse, keep replies in cache
		expandedComments.delete(commentId);
	} else {
		expandedComments.add(commentId);
		// Load replies if not already loaded or cached
		const comment = comments.find((c) => c.id === commentId);
		if (comment) {
			// Check if we have cached replies
			if (repliesCache.has(commentId)) {
				// Use cached replies
				const cachedReplies = repliesCache.get(commentId);
				comments = comments.map((c) => (c.id === commentId ? { ...c, replies: cachedReplies } : c));
			} else if (!comment.replies) {
				// Fetch replies if not cached and not already loaded
				const replies = await getCommentReplies(supabase, commentId);
				// Cache the replies
				repliesCache.set(commentId, replies);
				comments = comments.map((c) => (c.id === commentId ? { ...c, replies } : c));
			}
		}
	}
}
```

## Usage

```svelte
<CommentSection
	postId={post.id}
	postAuthorId={post.user_id}
	currentUserId={session?.user?.id}
	currentUser={session?.user}
	{supabase}
/>
```
