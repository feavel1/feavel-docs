# Comment and Like System

## Overview

The comment and like system provides interactive features for blog posts, allowing users to engage with content through comments and likes.

## Database Schema

### Post Comments Table

```sql
CREATE TABLE public.post_comments (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    post_id BIGINT NOT NULL REFERENCES public.posts(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    parent_id BIGINT REFERENCES public.post_comments(id) ON DELETE CASCADE,
    content TEXT NOT NULL,
    is_deleted BOOLEAN DEFAULT false,
    UNIQUE(post_id, user_id, created_at)
);
```

**Features:**

- Threaded comments with `parent_id` for replies
- Soft delete with `is_deleted` flag
- Automatic timestamps
- User ownership tracking

### Post Likes Table

```sql
CREATE TABLE public.post_likes (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    post_id BIGINT NOT NULL REFERENCES public.posts(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
    UNIQUE(post_id, user_id)
);
```

**Features:**

- One like per user per post (unique constraint)
- Simple toggle functionality
- Automatic timestamps

## Row Level Security (RLS)

### Comments RLS Policies

- **View**: Users can view non-deleted comments
- **Create**: Users can create comments (auth.uid() = user_id)
- **Update**: Users can update their own comments
- **Delete**: Users can delete their own comments OR post authors can delete any comment

### Likes RLS Policies

- **View**: Public read access
- **Create**: Users can create likes (auth.uid() = user_id)
- **Delete**: Users can delete their own likes

## Components

### CommentForm.svelte

A reusable form component for creating comments and replies.

**Props:**

- `postId`: The post ID
- `parentId`: Optional parent comment ID for replies
- `onSubmit`: Callback function for form submission
- `user`: Current user data
- `placeholder`: Custom placeholder text
- `buttonText`: Custom button text

**Features:**

- Real-time validation
- Keyboard shortcuts (Cmd+Enter to submit)
- Loading states
- Avatar display

### CommentItem.svelte

Displays individual comments with edit/delete functionality.

**Props:**

- `comment`: Comment data
- `currentUserId`: Current user ID for permissions
- `postAuthorId`: Post author ID for permissions
- `onReply`: Reply callback
- `onEdit`: Edit callback
- `onDelete`: Delete callback
- `showReplies`: Whether to show nested replies

**Features:**

- Edit/delete dropdown menu
- Author badge for post authors
- Relative timestamps
- Reply functionality
- Nested replies display

### CommentSection.svelte

Main comment section component that manages the comment list.

**Props:**

- `postId`: The post ID
- `postAuthorId`: Post author ID
- `currentUserId`: Current user ID
- `currentUser`: Current user data
- `supabase`: Supabase client

**Features:**

- Pagination (10 comments per page)
- Load more functionality
- Real-time comment updates
- Reply expansion
- Empty state handling

### LikeButton.svelte

A simple like button component with toggle functionality.

**Props:**

- `postId`: The post ID
- `currentUserId`: Current user ID
- `supabase`: Supabase client
- `initialLikeCount`: Initial like count
- `initialIsLiked`: Initial liked state

**Features:**

- Optimistic updates
- Loading states
- Visual feedback (heart icon)
- Like count display

## Utility Functions

### Comments (`src/lib/utils/comments.ts`)

- `getComments()`: Fetch paginated comments
- `getCommentReplies()`: Fetch replies for a comment
- `createComment()`: Create a new comment
- `updateComment()`: Update an existing comment
- `deleteComment()`: Soft delete a comment

### Likes (`src/lib/utils/likes.ts`)

- `getLikeCount()`: Get total like count for a post
- `isPostLiked()`: Check if user liked a post
- `toggleLike()`: Toggle like/unlike
- `getLikedUsers()`: Get list of users who liked

## API Endpoints

### Comments API (`/api/comments`)

- `POST`: Create a new comment
- `PUT`: Update an existing comment
- `DELETE`: Delete a comment

### Likes API (`/api/likes`)

- `POST`: Toggle like/unlike
- `GET`: Get like count and user like status

## Usage Example

```svelte
<script>
	import { CommentSection, LikeButton } from '$lib/components/modules';

	// In your post display page
</script>

<!-- Like Button -->
<LikeButton
	postId={post.id}
	currentUserId={session?.user?.id}
	supabase={session?.supabase}
	initialLikeCount={likeCount}
	initialIsLiked={isLiked}
/>

<!-- Comments Section -->
<CommentSection
	postId={post.id}
	postAuthorId={post.user_id}
	currentUserId={session?.user?.id}
	currentUser={session?.user}
	supabase={session.supabase}
/>
```

## Features

### Comments

- ✅ Threaded comments with replies
- ✅ Edit/delete functionality
- ✅ Pagination (10 per page)
- ✅ Load more button
- ✅ Real-time updates
- ✅ Author permissions (post authors can delete any comment)
- ✅ Soft delete (comments are hidden, not removed)
- ✅ Relative timestamps
- ✅ Reply count display

### Likes

- ✅ One like per user per post
- ✅ Toggle functionality (like/unlike)
- ✅ Real-time count updates
- ✅ Visual feedback
- ✅ Optimistic updates

### Security

- ✅ Row Level Security (RLS) enabled
- ✅ User authentication required for actions
- ✅ Proper permission checks
- ✅ Input validation
- ✅ SQL injection protection

## Migration Files

The system includes SQL migration files:

- `migrations/create_post_comments_table.sql`
- `migrations/create_post_likes_table.sql`

Run these migrations in your Supabase project to set up the database schema.
