# Comment System

## Overview

The comment system allows users to leave comments on blog posts and reply to existing comments. It includes features like nested replies, comment editing, and deletion.

## Components

### CommentSection.svelte

Main component that handles the display and management of comments for a post.

**Key Features:**

- Loads comments with pagination
- Handles comment creation, editing, and deletion
- Manages reply expansion/collapse
- Shows loading states

**Recent Fix:**

- Fixed infinite loading issue by adding proper state management with `hasLoaded` flag
- Prevents multiple API calls on component re-renders
- Added proper guards in `loadComments()` function

### CommentForm.svelte

Form component for creating new comments and replies.

### CommentItem.svelte

Individual comment display component with edit/delete functionality.

## Database Schema

The comment system uses the `post_comments` table with the following structure:

```sql
CREATE TABLE post_comments (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    post_id BIGINT NOT NULL REFERENCES posts(id),
    user_id UUID NOT NULL REFERENCES users(id),
    parent_id BIGINT REFERENCES post_comments(id),
    content TEXT NOT NULL,
    is_deleted BOOLEAN DEFAULT FALSE
);
```

## API Functions

### getComments(supabase, postId, page, limit)

Fetches comments for a specific post with pagination.

### getCommentReplies(supabase, commentId)

Fetches replies for a specific comment.

### createComment(supabase, postId, userId, commentData)

Creates a new comment or reply.

### updateComment(supabase, commentId, content)

Updates an existing comment.

### deleteComment(supabase, commentId)

Soft deletes a comment by setting `is_deleted` to true.

## Bug Fixes

### Infinite Loading Issue (Fixed)

**Problem:** Comments were being fetched infinitely, causing the loading spinner to never disappear.

**Root Cause:** The `$effect(() => { loadComments(); })` was running on every component re-render without proper dependencies.

**Solution:**

1. Added `hasLoaded` state flag to prevent multiple loads
2. Added proper guards in `loadComments()` function
3. Improved effect dependency management

```svelte
// Before (problematic)
$effect(() => {
    loadComments();
});

// After (fixed)
let hasLoaded = $state(false);

$effect(() => {
    if (postId && !hasLoaded) {
        hasLoaded = true;
        loadComments();
    }
});
```

## Usage

```svelte
<CommentSection
	postId={post.id}
	postAuthorId={post.user_id}
	currentUserId={session?.user?.id}
	currentUser={session?.user}
	{supabase}
/>
```
